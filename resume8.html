<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Resume</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#0f172a 0%, #020617 100%); color: #e6eef8; min-height:100vh; }
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 20px; }
    .muted { color: rgba(230,238,248,0.7); font-size: 13px; }
    /* Top-right auth widget */
    .top-auth {
      position: fixed;
      right: 18px;
      top: 12px;
      z-index: 60;
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      padding:8px 12px;
      border-radius:10px;
      backdrop-filter: blur(6px);
      color: #e6eef8;
      font-size:13px;
    }
    .top-auth .muted { color: rgba(230,238,248,0.7); }
    .top-auth .email { font-weight:600; color: #fff; }
    .top-auth .btn-outline {
      background: transparent;
      border: 1px solid rgba(230,238,248,0.08);
      color: #e6eef8;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
    }
    a.resume-link { color: #7dd3fc; text-decoration: underline; }
    @media (max-width:640px){ .top-auth { right:8px; left:8px; justify-content:space-between; } }
  </style>
</head>
<body>

  <!-- Top-right small auth area -->
  <div id="topAuth" class="top-auth" aria-live="polite">
    <span class="muted">Checking sign-in...</span>
  </div>

  <div class="max-w-5xl mx-auto p-6">
    <div class="glass">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-semibold">Resume</h1>
          <p class="muted"></p>
        </div>
        <div class="text-right">
          <small class="muted">CodeAKD</small>
        </div>
      </div>

      <div id="profileArea" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        <aside class="col-span-1">
          <img id="profile-avatar" src="https://placehold.co/160x160/0f172a/7dd3fc?text=Avatar" alt="avatar" class="w-40 h-40 rounded-lg object-cover border-2 border-white/10">
          <h2 id="profile-name" class="text-xl font-semibold mt-4">Loading...</h2>
          <p id="profile-email" class="muted"></p>
          <div id="social-links" class="mt-3 muted">Loading links...</div>
        </aside>

        <div class="col-span-2 space-y-4">
          <section id="experience-section" class="glass section-hidden p-4">
            <h3 class="font-semibold">Experience</h3>
            <div id="experience-list" class="mt-3 muted">Loading...</div>
          </section>

          <section id="education-section" class="glass section-hidden p-4">
            <h3 class="font-semibold">Education</h3>
            <div id="education-list" class="mt-3 muted">Loading...</div>
          </section>

          <section id="skills-section" class="glass section-hidden p-4">
            <h3 class="font-semibold">Skills</h3>
            <div id="skills-list" class="mt-3 muted">Loading...</div>
          </section>
        </div>
      </div>
    </div>
  </div>

<script>
/* -----------------------
   AUTH HELPERS (shared)
   ----------------------- */
function getStoredTokenCandidates(){
  return {
    idToken: sessionStorage.getItem('idToken') || localStorage.getItem('idToken') || sessionStorage.getItem('id_token') || localStorage.getItem('id_token'),
    accessToken: sessionStorage.getItem('accessToken') || localStorage.getItem('accessToken') || sessionStorage.getItem('access_token') || localStorage.getItem('access_token'),
    generic: sessionStorage.getItem('accessToken') || localStorage.getItem('accessToken') || sessionStorage.getItem('idToken') || localStorage.getItem('idToken')
  };
}

async function getIdTokenFromCognitoSDK(){
  try {
    if(window.AmazonCognitoIdentity && typeof window.CognitoUserPool !== 'undefined'){
      const userPool = window.userPool || window.cognitoUserPool;
      if(userPool && userPool.getCurrentUser){
        const user = userPool.getCurrentUser();
        if(user && user.getSession){
          const session = await new Promise((res, rej) => user.getSession((e,s) => e ? rej(e) : res(s)));
          return session.getIdToken().getJwtToken();
        }
      }
    }
  } catch (e) { console.warn('Cognito SDK token fetch failed', e); }
  return null;
}

async function getIdToken(){
  const cand = getStoredTokenCandidates();
  if(cand.idToken) return cand.idToken;
  if(cand.generic) return cand.generic;
  const sdk = await getIdTokenFromCognitoSDK();
  if(sdk) return sdk;
  return null;
}

function getUserEmail(){ return sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail') || ''; }
function getUserFullName(){ return sessionStorage.getItem('userFullName') || localStorage.getItem('userFullName') || ''; }

/* -----------------------
   RENDER TOP AUTH
   ----------------------- */
async function renderTopAuth(){
  const container = document.getElementById('topAuth');
  const token = await getIdToken();
  const email = getUserEmail();
  const fullName = getUserFullName();

  container.innerHTML = '';

  if(!token && !email){
    container.innerHTML = `
      <span class="muted">Not signed in</span>
      <a href="auth.html" class="resume-link">Sign in</a>
    `;
    return;
  }

  const displayName = fullName || email || 'user';
  container.innerHTML = `
    <span class="muted">Signed in as</span>
    <span class="email">${displayName}</span>
    <button id="signOutBtn" class="btn-outline">Sign out</button>
  `;

  document.getElementById('signOutBtn').addEventListener('click', () => {
    try {
      sessionStorage.clear();
      localStorage.removeItem('idToken');
      localStorage.removeItem('accessToken');
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userFullName');
    } catch(e){ console.warn('error clearing storage', e); }
    window.location.href = 'auth.html';
  });
}

/* -----------------------
   PROFILE FETCH & RENDER
   ----------------------- */
/*
  To use live DynamoDB-backed data:
  - set USE_MOCK_DATA = false
  - set API_GATEWAY_URL to your endpoint that returns the profile JSON for the authenticated user
  The script will include Authorization: Bearer <idToken> when available.
*/
const USE_MOCK_DATA = false;
const API_GATEWAY_URL = "https://98waznpkua.execute-api.us-east-1.amazonaws.com/prod/profile"; // e.g. https://abc.execute-api.us-east-1.amazonaws.com/prod/profile

const mockData = {
  "meta": {
    "name": "Abhisek Das",
    "email": "",
    "avatarUrl": "https://images.unsplash.com/photo-1570295999919-56ceb5ecca61?auto=format&fit=crop&w=880&q=80",
    "linkedin": "https://www.linkedin.com/in/breakstigma",
    "github": "https://github.com/CodeAKD"
  },
  "skills": [{ "id":"s1","value":"Python" },{ "id":"s2","value":"React" },{ "id":"s3","value":"AWS" }],
  "experience": [
    { "id":"e1","title":"","org":"","start":"","end":"","details":"Coordinated project timelines and contributed to front-end development." },
    { "id":"e2","title":"Junior Developer Intern","org":"Tech Solutions Ltd.","start":"2022","end":"2023","details":"Developed internal tools and automated reporting." }
  ],
  "education":[ { "id":"ed1","title":"B.Tech in Computer Science","org":"","start":"","end":"","percentage":"","details":"Graduated with honors." } ]
};

function renderMeta(meta){
  if(!meta) return;
  document.getElementById('profile-name').textContent = meta.name || 'N/A';
  document.getElementById('profile-email').textContent = meta.email || '';
  const avatar = document.getElementById('profile-avatar');
  if(meta.avatarUrl) { avatar.src = meta.avatarUrl; avatar.onerror = () => { avatar.src = 'https://placehold.co/160x160/0f172a/7dd3fc?text=Err'; }; }
  const links = document.getElementById('social-links');
  links.innerHTML = '';
  if(meta.linkedin) links.innerHTML += `<a class="resume-link mr-4" href="${meta.linkedin}" target="_blank" rel="noopener">LinkedIn</a>`;
  if(meta.github) links.innerHTML += `<a class="resume-link" href="${meta.github}" target="_blank" rel="noopener">GitHub</a>`;
}

function renderSection(sectionId, listId, items, renderItem){
  const section = document.getElementById(sectionId);
  const list = document.getElementById(listId);
  if(!items || items.length===0){ section.classList.add('section-hidden'); return; }
  section.classList.remove('section-hidden');
  list.innerHTML = '';
  items.forEach(it => list.innerHTML += renderItem(it));
}

function renderSkillItem(s){ return `<span class="inline-block bg-white/6 text-sm px-3 py-1 rounded-full mr-2 mb-2">${s.value}</span>`; }
function renderExperienceItem(e){ return `<div class="mb-3"><div class="text-sm text-white/70 font-medium">${e.start} - ${e.end}</div><div class="font-semibold text-lg">${e.title}</div><div class="text-sm text-white/60">${e.org}</div><p class="mt-1 text-white/70">${e.details}</p></div>`; }
function renderEducationItem(ed){ return `<div class="mb-3"><div class="text-sm text-white/70 font-medium">${ed.start} - ${ed.end}</div><div class="font-semibold">${ed.title}</div><div class="text-sm text-white/60">${ed.org}</div>${ed.percentage?`<div class="text-sm mt-1">Percentage: ${ed.percentage}%</div>`:''}<p class="mt-1 text-white/70">${ed.details||''}</p></div>`; }

async function loadProfile(){
  let data = {};
  try {
    if(USE_MOCK_DATA) data = mockData;
    else {
      const idToken = await getIdToken();
      const headers = idToken ? { 'Authorization': 'Bearer ' + idToken } : {};
      // Optionally include userEmail as query param: `${API_GATEWAY_URL}?email=${encodeURIComponent(getUserEmail())}`
      const resp = await fetch(API_GATEWAY_URL, { headers });
      if(!resp.ok) throw new Error('Network response not ok: ' + resp.status);
      data = await resp.json();
    }
    renderMeta(data.meta);
    renderSection('skills-section','skills-list', data.skills, renderSkillItem);
    renderSection('experience-section','experience-list', data.experience, renderExperienceItem);
    renderSection('education-section','education-list', data.education, renderEducationItem);
  } catch(err){
    console.error('Failed to load profile', err);
    // non-blocking: keep page usable
    document.getElementById('profile-name').textContent = 'Profile not loaded';
    document.getElementById('experience-list').textContent = 'Unable to fetch profile. Check console for errors.';
  }
}

/* initialize: render auth first (so idToken is available), then load profile */
window.addEventListener('load', async () => {
  await renderTopAuth();
  await loadProfile();
});
</script>
</body>
</html>
